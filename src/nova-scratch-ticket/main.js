(function(){(function(){(function(e,t){if(typeof exports=="object")module.exports=t();else if(typeof define=="function"&&define.amd)define("src/nova-scratch-ticket/main",[],t);else{var n="__0",r=n.split("."),i=e;for(var s=0;s<r.length-1;s++)i[r[s]]===undefined&&(i[r[s]]={}),i=i[r[s]];i[r[r.length-1]]=t()}})(this,function(){function e(e){return{}[e]}var t=undefined;return NovaExports.__fixedUglify="script>",NovaExports.exports={stylesheet:":host{display:block}"},Nova.Components.NovaScratchTicket=NovaExports({is:"nova-scratch-ticket","extends":"canvas",props:{img:String,color:{type:String,value:"#7d838b"},fingerWidth:{type:Number,value:30},threshold:{type:Number,value:.5}},createdHandler:function(){this.ele=this,this.$ele=$(this);var e=this.ele.getContext("2d");e.lineWidth=this.fingerWidth,e.lineCap=e.lineJoin="round",e.strokeStyle="black",this.ctx=e,this._eventEle=$({}),this._init()},_init:function(){this._drawImage(),this._bindEvents()},_drawImage:function(){var e=this,t=e.img,n,r=e.ele.width,i=e.ele.height;e.ctx.globalCompositeOperation="source-over",e.ctx.fillStyle=e.color,e.ctx.fillRect(0,0,r,i);if(!t)return;typeof t=="string"?(n=new Image,n.crossOrigin="*",n.onload=function(){e.ctx.drawImage(n,0,0,r,i),e._forceRepaint()},n.src=t):(n=t,e.ctx.drawImage(n,0,0,r,i)),e._forceRepaint()},_bindEvents:function(){function n(t){t.preventDefault();var n=e._getCoors(t);e._scratchLine(n.x,n.y)}function r(){e.ctx.closePath();var i=e.getScratchRatio();i>e.threshold&&!e.__scratched&&(e.trigger("scratchoff"),e.__scratched=!0),t.off("touchmove",n),t.off("touchend",r)}var e=this,t=$("body");e.$ele.on("touchstart",function(i){e.offset=e.$ele.offset();var s=e._getCoors(i);e._scratchLine(s.x,s.y,!0),t.on("touchmove",n),t.on("touchend",r)})},_scratchLine:function(e,t,n){n&&(this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.moveTo(e+.01,t)),this.ctx.lineTo(e,t),this.ctx.stroke(),this._forceRepaint()},_getCoors:function(e){var t,n={},r=this.offset;return(t=e.changedTouches[0])?(n.pageX=t.pageX,n.pageY=t.pageY):(n.pageX=e.pageX,n.pageY=e.pageY),{x:n.pageX-r.left,y:n.pageY-r.top}},_forceRepaint:function(){this.$ele.css("color")==="red"?this.$ele.css("color","black"):this.$ele.css("color","red")},getScratchRatio:function(){var e=this.ctx.getImageData(0,0,this.ele.width,this.ele.height),t=e.data,n=4,r=t.length/4,i=0;for(var s=0;s<t.length;s+=n)t[s]!=0&&i++;return 1-i/r},refresh:function(){this._drawImage(),this.__scratched=!1},clear:function(){this.ctx.globalCompositeOperation="destination-out",this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.ele.width,this.ele.height),this.__scratched=!0,this._forceRepaint()}}),t})}).call(window)})();